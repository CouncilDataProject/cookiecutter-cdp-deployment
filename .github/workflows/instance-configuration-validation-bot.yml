name: Instance Configuration Validation Bot

on:
  issues:
    types:
      - opened
      - edited

jobs:
  validate-form:
    if: ${{ contains(github.event.issue.labels.*.name, 'new instance') }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      #########################################################################
      # Initial Hello and Documentation

      - name: Find Any Bot Comment
        uses: peter-evans/find-comment@v1
        id: find-any-bot-comment
        with:
          issue-number: ${{ github.event.issue.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Thanks for initiating the process'

      - name: Post Hello
        uses: peter-evans/create-or-update-comment@v1
        if: ${{ steps.find-any-bot-comment.outputs.comment-id == 0 }}
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Hello! ðŸ‘‹
            Thanks for initiating the process to configure a new CDP instance.

            I am a bot that will check out the information provided in your form. If any checks fail, please update your issue by opening the 'ðŸž„ðŸž„ðŸž„' dropdown and selecting 'Edit'.

            _This comment was written by a bot!_

      #########################################################################
      # Workflow Setup

      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install Bot Scripts Dependencies
        run: |
          pip install -r .github/workflows/scripts/requirements.txt

      #########################################################################
      # Parsing Form and Logging Details

      - name: Dump Issue Body to File
        run: |
          echo "${{ github.event.issue.body }}" > issue-body.md
      - name: Validate Form and Create Bot Response
        run: |
          python .github/workflows/scripts/validate-form.py issue-body.md

      - name: Set Response Content
        id: validation-message-response
        run: |
          body=$(cat form-validation-results.md)
          body="${body//'%'/'%25'}"
          body="${body//$'\n'/'%0A'}"
          body="${body//$'\r'/'%0D'}" 
          echo ::set-output name=body::$body

      - name: Find Prior Validation Results  
        uses: peter-evans/find-comment@v1
        id: find-validation-message
        with:
          issue-number: ${{ github.event.issue.number }}
          comment-author: 'github-actions[bot]'
          body-includes: 'Form Validation Results'

      - name: Post Validation Results
        if: ${{ steps.find-validation-message.outputs.comment-id == 0 }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            Hello! ðŸ‘‹

            Thanks for initiating the process to configure a new CDP instance.

            I am a bot that will check out the information provided in your form.
            If any checks fail, please update your issue by opening the 'ðŸž„ðŸž„ðŸž„' dropdown and
            selecting 'Edit'.

            ### Form Validation Results
            
            ${{ steps.validation-message-response.outputs.body }}
            
            _This comment was written by a bot!_
      
      - name: Update Validation Results
        if: ${{ steps.find-validation-message.outputs.comment-id != 0 }}
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ steps.find-validation-message.outputs.comment-id }}
          edit-mode: 'replace'
          body: |
            Hello! ðŸ‘‹

            Thanks for initiating the process to configure a new CDP instance.

            I am a bot that will check out the information provided in your form.
            If any checks fail, please update your issue by opening the 'ðŸž„ðŸž„ðŸž„' dropdown and
            selecting 'Edit'.

            ### Form Validation Results
            
            ${{ steps.validation-message-response.outputs.body }}
            
            _This comment was written by a bot!_