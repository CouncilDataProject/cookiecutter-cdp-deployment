name: Instance Deployment Bot

on:
  issue_comment:
    types:
      - created

jobs:
  deploy-new-instance:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.html_url, '/issues/') &&
      contains(github.event.comment.body, '/cdp-deploy')

    steps:
      #########################################################################
      # Check initiator is a member of CDP

      - name: Get CDP Organization Members
        id: cdp-members
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          members="$(gh api -X GET 'orgs/CouncilDataProject/members' -F per_page=100 --paginate --cache 1h --jq '[.[].login] | join("---")')"
          echo "::set-output name=members::$members"

      - name: Generate Safe Username Check
        id: safe-username
        run: |
          username=${{ github.event.comment.user.login }}
          username="---$username---"
          echo "::set-output name=username::$username"

      - name: Check Job Initiator - Message
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            ❌ ❌ **Rejected** ❌ ❌
            
            User (${{ github.event.comment.user.login }}) attempted to deploy without permissions.

            _Only users which are members of the CouncilDataProject organization can deploy new instances with this bot._

            **Stopping Deployment Procedure**
      
      - name: Check Job Initiator - Exit
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        run: |
          exit 1

      #########################################################################
      # Workflow Setup

      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install Bot Scripts Dependencies
        run: |
          pip install -r .github/workflows/scripts/requirements.txt
          pip install cookiecutter

      # Run Validation Bot to get Configuration Options
      - name: Dump Issue Body to File
        run: |
          echo "${{ github.event.issue.body }}" > issue-body.md
      - name: Validate Form and Generate Configuration Files
        run: |
          python .github/workflows/scripts/validate-form.py issue-body.md

      # Store Cookiecutter Options
      - name: Store Cookiecutter Options
        id: cookiecutter-options
        run: |
          content=$(cat planned-cookiecutter.json)
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}" 
          echo ::set-output name=options::$content

      #########################################################################
      # Run fast checks

      - name: Read generation-options JSON
        id: generation-options
        run: |
          content="$(cat generation-options.json)"
          echo "::set-output name=content::$content"

      - name: Error Early - Message
        uses: peter-evans/create-or-update-comment@v1
        if: |
          fromJSON(steps.generation-options.outputs.content).scraper_path == null ||
          fromJSON(steps.generation-options.outputs.content).maintainer_name == null ||
          fromJSON(steps.generation-options.outputs.content).repository_path == null
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            :warning: :warning: **Configuration Error** :warning: :warning:

            Not all configuration options are present or some options have errors.

            #### Configuration Options

            ```json
            ${{ steps.generation-options.outputs.content }}
            ```

            **Stopping Deployment Procedure**
      
      - name: Error Early - Exit
        if: |
          fromJSON(steps.generation-options.outputs.content).scraper_path == null ||
          fromJSON(steps.generation-options.outputs.content).maintainer_name == null ||
          fromJSON(steps.generation-options.outputs.content).repository_path == null
        run: |
          exit 1
    
      #########################################################################
      # Proceed with deployment

      - name: Run Cookiecutter
        run: |
          mv planned-cookiecutter.json cookiecutter.json
          cookiecutter . --no-input

      - name: Create New Instance Repo and Push
        run: |
          cd ${{ fromJSON(steps.cookiecutter-options.outputs.options ).hosting_github_repo_name }}
          git config --global user.email "councildataproject@gmail.com"
          git config --global user.name "CouncilDataProjectServiceAccount"
          git init
          git checkout -b main
          git add -A
          git commit -m "Initial commit"
          gh repo create \
            ${{ fromJSON(steps.generation-options.outputs.content).repository_path }} \
            --public \
            --description "CDP Instance for ${{ fromJSON(steps.cookiecutter-options.outputs.options).municipality }}" \
            --homepage "${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_web_app_address }}" \
            --enable-wiki=false \
            --confirm
          git remote set-url origin https://CouncilDataProject:${{ secrets.ACCESS_TOKEN }}@github.com/${{ fromJSON(steps.generation-options.outputs.content).repository_path }}.git
          git push -u origin main
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Log Success
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            :tada: :tada: **Completed** :tada: :tada:
            
            New CouncilDataProject Instance Repository was created ([${{ fromJSON(steps.generation-options.outputs.content).repository_path }}](${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_github_url }})), external collaborator added (@${{ fromJSON(steps.generation-options.outputs.content).maintainer_name }}), and cookiecutter files generated and pushed to repository.

            The instance should be setting itself up right now. See [the instance's GitHub Action job history](${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_github_url }}/actions) for more details as to progress of deployment setup.

            At any point in the future if you would like to destroy this instance, please just add a comment to this thread and a maintainer will help you.