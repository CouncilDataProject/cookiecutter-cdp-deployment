name: Instance Deployment Bot

on:
  issue_comment:
    types:
      - created

jobs:
  deploy-instance:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.html_url, '/issues/') &&
      contains(github.event.comment.body, '/cdp-deploy')

    steps:
      #########################################################################
      # Check initiator is a member of CDP

      - name: Get CDP Organization Members
        id: cdp-members
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          members="$(gh api -X GET 'orgs/CouncilDataProject/members' -F per_page=100 --paginate --cache 1h --jq '[.[].login] | join("---")')"
          echo "::set-output name=members::$members"

      - name: Generate Safe Username Check
        id: safe-username
        run: |
          username=${{ github.event.comment.user.login }}
          username="---$username---"
          echo "::set-output name=username::$username"

      - name: Check Job Initiator - Message
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            ❌ ❌ **Rejected** ❌ ❌
            
            User (${{ github.event.comment.user.login }}) attempted to deploy without permissions.

            _Only users which are members of the CouncilDataProject organization can deploy new instances with this bot._

            **Stopping Deployment Procedure**
      
      - name: Check Job Initiator - Exit
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        run: |
          exit 1

      #########################################################################
      # Workflow Setup

      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install Bot Scripts Dependencies
        run: |
          pip install -r .github/workflows/scripts/requirements.txt
          pip install cookiecutter

      # Run Validation Bot to get Configuration Options
      - name: Dump Issue Body to File
        run: |
          echo "${{ github.event.issue.body }}" > issue-body.md
      - name: Validate Form and Generate Configuration Files
        run: |
          python .github/workflows/scripts/validate_form.py issue-body.md

      # Store Cookiecutter Options
      - name: Store Cookiecutter Options
        id: cookiecutter-options
        run: |
          content=$(cat planned-cookiecutter.json)
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}" 
          echo ::set-output name=options::$content

      #########################################################################
      # Run fast checks

      - name: Read generation-options JSON
        id: generation-options
        run: |
          content="$(cat generation-options.json)"
          echo "::set-output name=content::$content"

      - name: Error Early - Message
        uses: peter-evans/create-or-update-comment@v1
        if: |
          fromJSON(steps.generation-options.outputs.content).scraper_path == null ||
          fromJSON(steps.generation-options.outputs.content).maintainer_name == null ||
          fromJSON(steps.generation-options.outputs.content).repository_path == null
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            :warning: :warning: **Configuration Error** :warning: :warning:

            Not all configuration options are present or some options have errors.

            #### Configuration Options

            ```json
            ${{ steps.generation-options.outputs.content }}
            ```

            **Stopping Deployment Procedure**
      
      - name: Error Early - Exit
        if: |
          fromJSON(steps.generation-options.outputs.content).scraper_path == null ||
          fromJSON(steps.generation-options.outputs.content).maintainer_name == null ||
          fromJSON(steps.generation-options.outputs.content).repository_path == null
        run: |
          exit 1
    
      #########################################################################
      # Proceed with deployment

      - name: Run Cookiecutter
        run: |
          mv planned-cookiecutter.json cookiecutter.json
          cookiecutter . --no-input

      - name: Get Municipality Slugs
        id: municipality-slug
        run: |
          slug=$(jq -r '.municipality_slug' cookiecutter.json)
          python_slug=$(jq -r '.python_municipality_slug' cookiecutter.json)
          echo "::set-output name=slug::$slug"
          echo "::set-output name=python_slug::$python_slug"

      - name: Init Git
        run: |
          cd ${{ steps.municipality-slug.outputs.slug }}
          git config --global user.email "councildataproject@gmail.com"
          git config --global user.name "CouncilDataProjectServiceAccount"
          git init
          git checkout -b main
          git add -A
          git commit -m "Initial commit"

      # Replace scraper with provided
      - name: Add cdp-scrapers as dependency
        run: |
          sed -i \
              '21 i \    "cdp-scrapers[${{ steps.municipality-slug.outputs.python_slug }}]~=0.2",' \
              ${{ steps.municipality-slug.outputs.slug }}/python/setup.py

      # Get scraper path and update scraper function
      - name: Get Scraper Path
        id: selected-scraper
        run: |
          scraper_options=$(jq -r '.scraper_path' generation-options.json)
          scraper_choice=$(echo $scraper_path | cut -f1 -d %)
          param1=$(echo $scraper_path | cut -f2 -d %)
          param2=$(echo $scraper_path | cut -f3 -d %)
          echo "::set-output name=choice::$scraper_choice"
          echo "::set-output name=param1::$param1"
          echo "::set-output name=param2::$param2"

      # Use base legistar for scraper
      - name: Add Base Legistar Scraper
        if: |
          contains(steps.selected-scraper.outputs.choice, "USE_BASE_LEGISTAR")
        run: |
          sed \
            's/REPLACE_LEGISTAR_CLIENT/${{ steps.selected-scraper.outputs.param1 }}/g' \
            .github/workflows/resources/base_legistar_scraper.py
          sed \
            's/REPLACE_LEGISTAR_TZ/${{ steps.selected-scraper.outputs.param2 }}/g' \
            .github/workflows/resources/base_legistar_scraper.py
          mv \
            .github/workflows/resources/base_legistar_scraper.py \
            ${{ steps.municipality-slug.outputs.slug }}/python/cdp_${{ steps.municipality-slug.outputs.python_slug }}_backend/scraper.py

      # Use custom scraper
      - name: Add Custon Scraper
        if: |
          contains(steps.selected-scraper.outputs.choice, "USE_FOUND_SCRAPER")
        run: |
          sed \
            's/REPLACE_CUSTOM_SCRAPER/${{ steps.selected-scraper.outputs.param1 }}/g' \
            .github/workflows/resources/custom_scraper.py
          mv \
            .github/workflows/resources/custom_scraper.py \
            ${{ steps.municipality-slug.outputs.slug }}/python/cdp_${{ steps.municipality-slug.outputs.python_slug }}_backend/scraper.py
      
      # Commit scraper changes
      - name: Commit Scraper Dep and Usage
        run: |
          cd ${{ steps.municipality-slug.outputs.slug }}
          git add -A
          git commit -m "Add cdp-scrapers dependency"

      - name: Setup Git SSH
        run: |
          eval "$(ssh-agent -s)"
          mkdir ~/.ssh/
          echo "${{ secrets.SA_SSH_KEY }}" > ~/.ssh/id_cdp_sa
          chmod 600 ~/.ssh/id_cdp_sa
          ssh-add ~/.ssh/id_cdp_sa
          echo "Host github.com
            HostName github.com
            IdentityFile ~/.ssh/id_cdp_sa" > ~/.ssh/config

      - name: Create New Instance Repo and Push
        run: |
          cd ${{ fromJSON(steps.cookiecutter-options.outputs.options ).hosting_github_repo_name }}
          gh repo create \
            ${{ fromJSON(steps.generation-options.outputs.content).repository_path }} \
            --public \
            --description "CDP Instance for ${{ fromJSON(steps.cookiecutter-options.outputs.options).municipality }}" \
            --homepage "${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_web_app_address }}" \
            --enable-wiki=false \
            --confirm
          git remote set-url origin git@github.com:${{ fromJSON(steps.generation-options.outputs.content).repository_path }}
          git push -u origin main
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      # Sleep for a while

      # add external collab if person not in CDP org

      # - name: Enable GitHub Pages
      #   run: |
      #     echo "Enabling pages for ${{ steps.municipality-slug.outputs.slug }}"
      #     jq -n '{"source":{"branch":"gh-pages"}}' | \
      #       gh api \
      #       -H "Accept: application/vnd.github.switcheroo-preview+json" \
      #       repos/CouncilDataProject/${{ steps.municipality-slug.outputs.slug }}/pages \
      #       --input -
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Log Success
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Deployment Status

            :tada: :tada: **Completed** :tada: :tada:
            
            New CouncilDataProject Instance Repository was created ([${{ fromJSON(steps.generation-options.outputs.content).repository_path }}](${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_github_url }})), external collaborator added (@${{ fromJSON(steps.generation-options.outputs.content).maintainer_name }}), and cookiecutter files generated and pushed to repository.

            The instance should be setting itself up right now. See [the instance's GitHub Action job history](${{ fromJSON(steps.cookiecutter-options.outputs.options).hosting_github_url }}/actions) for more details as to progress of deployment setup.

            At any point in the future if you would like to destroy this instance, please just add a comment to this thread and a maintainer will help you.

  destroy-instance:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.html_url, '/issues/') &&
      contains(github.event.comment.body, '/cdp-destroy')

    steps:
      #########################################################################
      # Check initiator is a member of CDP

      - name: Get CDP Organization Members
        id: cdp-members
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        run: |
          members="$(gh api -X GET 'orgs/CouncilDataProject/members' -F per_page=100 --paginate --cache 1h --jq '[.[].login] | join("---")')"
          echo "::set-output name=members::$members"

      - name: Generate Safe Username Check
        id: safe-username
        run: |
          username=${{ github.event.comment.user.login }}
          username="---$username---"
          echo "::set-output name=username::$username"

      - name: Check Job Initiator - Message
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Destruction Status

            ❌ ❌ **Rejected** ❌ ❌
            
            User (${{ github.event.comment.user.login }}) attempted to destroy without permissions.

            _Only users which are members of the CouncilDataProject organization can destroy instances with this bot._

            **Stopping Destruction Procedure**
      
      - name: Check Job Initiator - Exit
        if: |
          !contains(
            steps.cdp-members.outputs.members,
            steps.safe-username.outputs.username
          )
        run: |
          exit 1

      #########################################################################
      # Workflow Setup

      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v1
        with:
          python-version: 3.9
      - name: Install Bot Scripts Dependencies
        run: |
          pip install -r .github/workflows/scripts/requirements.txt

      - name: Dump Issue Body to File
        run: |
          echo "${{ github.event.issue.body }}" > issue-body.md
      - name: Generate Cookiecutter File
        run: |
          python .github/workflows/scripts/parse_form.py issue-body.md

      #########################################################################
      # Proceed with destory

      - name: Get Municipality Slug
        id: municipality-slug
        run: |
          slug=$(jq -r '.municipality_slug' planned-cookiecutter.json)
          echo "::set-output name=slug::$slug"

      - name: Delete Repository
        run: |
          echo "Deleting CouncilDataProject/${{ steps.municipality-slug.outputs.slug }}"
          gh api \
            -X DELETE \
            'repos/CouncilDataProject/${{ steps.municipality-slug.outputs.slug }}'
        env:
          GITHUB_TOKEN: ${{ secrets.ACCESS_TOKEN }}

      - name: Log Success
        uses: peter-evans/create-or-update-comment@v1
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## Destruction Status

            :wave: :wave: **Completed** :wave: :wave:
            
            The CouncilDataProject Instance Repository and Infrastructure for **${{ steps.municipality-slug.outputs.slug }}** has been destroyed.

      # Delete stack on pulumi
      # Delete gcloud project